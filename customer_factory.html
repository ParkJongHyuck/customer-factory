<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>고객 공장 다이어그램</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .diagram-container {
            width: 100%;
            max-width: 1400px;
            height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loading {
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }

        .error-message {
            width: 100%;
            max-width: 1400px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .error-message strong {
            font-weight: 600;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .node-box {
            fill: white;
            stroke: #6c757d;
            stroke-width: 2;
            rx: 20;
        }

        .node-factory {
            fill: white;
            stroke: #6c757d;
            stroke-width: 2;
        }

        .node-text-title {
            font-size: 14px;
            font-weight: 600;
            fill: #495057;
            text-anchor: middle;
        }

        .node-text-value {
            font-size: 16px;
            font-weight: 700;
            fill: #212529;
            text-anchor: middle;
        }

        .arrow {
            stroke: #6c757d;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .arrow-curved {
            stroke: #6c757d;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .arrow-label {
            font-size: 12px;
            fill: #6c757d;
            text-anchor: middle;
        }

        .rate-label {
            font-size: 11px;
            fill: #6c757d;
            text-anchor: middle;
        }
    </style>
</head>
<body>
    <div class="diagram-container" id="diagram-container">
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading">데이터 로딩 중...</div>
        </div>
    </div>
    <div class="error-message" id="error-message"></div>

    <script>
        // 하드코딩된 설정값
        const SHEET_ID = '1Up0FHYHBlYzZhdDvcVBe9xHZWVxefUQNg5CRgXlzZbE';
        const API_KEY = 'AIzaSyCtgQLWJiGP1c4GfY-gLXBnIZNZH71XMVc';
        const SHEET_NAME = '2026';

        // 기본값 (에러 시 사용)
        const DEFAULT_DATA = {
            현재고객: '-',
            월간이탈: '-',
            추천: '-',
            신규고객: '-',
            활성고객: '-',
            월방문자: '-',
            관심고객: '-',
            이탈율: '-',
            추천율: '-',
            전환율: '-',
            활보율: '-'
        };

        async function loadFromSheets() {
            try {
                const range = `${SHEET_NAME}!A:L`;
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API 오류 (${response.status})`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length < 2) {
                    throw new Error('데이터가 충분하지 않습니다 (최소 2행 필요)');
                }

                // 2번째 행 데이터 (index 1)
                const row = data.values[1];
                const headers = data.values[0];
                
                // 데이터 파싱 (헤더 기반)
                const dataMap = {};
                headers.forEach((header, idx) => {
                    dataMap[header] = row[idx] || '0';
                });

                // 필요한 값들 추출
                const 현재고객 = parseInt(dataMap['현재고객'] || dataMap['현재_고객'] || '0') || 0;
                const 월간이탈 = parseInt(dataMap['월간이탈'] || dataMap['월간_이탈'] || '0') || 0;
                const 추천 = parseInt(dataMap['추천'] || '0') || 0;
                const 신규고객 = parseInt(dataMap['신규고객'] || dataMap['신규_고객'] || '0') || 0;
                const 활성고객 = parseInt(dataMap['활성고객'] || dataMap['활성_고객'] || '0') || 0;
                const 월방문자 = parseInt(dataMap['월방문자'] || dataMap['월_방문자'] || '0') || 0;
                const 관심고객 = parseInt(dataMap['관심고객'] || dataMap['관심_고객'] || '0') || 0;
                
                // 계산된 비율
                const 이탈율 = 현재고객 > 0 ? ((월간이탈 / 현재고객) * 100).toFixed(1) : '0.0';
                const 추천율 = 신규고객 > 0 ? ((추천 / 신규고객) * 100).toFixed(0) : '0';
                const 전환율 = 관심고객 > 0 ? ((신규고객 / 관심고객) * 100).toFixed(0) : '0';
                const 활보율 = 월방문자 > 0 ? ((관심고객 / 월방문자) * 100).toFixed(0) : '0';

                drawDiagram({
                    현재고객: 현재고객.toLocaleString(),
                    월간이탈: 월간이탈.toLocaleString(),
                    추천: 추천.toLocaleString(),
                    신규고객: 신규고객.toLocaleString(),
                    활성고객: 활성고객.toLocaleString(),
                    월방문자: 월방문자.toLocaleString(),
                    관심고객: 관심고객.toLocaleString(),
                    이탈율,
                    추천율,
                    전환율,
                    활보율
                });

                // 로딩 오버레이 제거
                document.getElementById('loading-overlay').style.display = 'none';
                
            } catch (error) {
                console.error('Error:', error);
                
                // 기본값으로 다이어그램 표시
                drawDiagram(DEFAULT_DATA);
                
                // 로딩 오버레이 제거
                document.getElementById('loading-overlay').style.display = 'none';
                
                // 에러 메시지 하단 표시
                const errorEl = document.getElementById('error-message');
                errorEl.innerHTML = `<strong>⚠️ 데이터 로드 실패:</strong> ${error.message}`;
                errorEl.classList.add('show');
            }
        }

        function drawDiagram(data) {
            const container = document.getElementById('diagram-container');
            
            const svg = `
<svg viewBox="0 0 1400 400" xmlns="http://www.w3.org/2000/svg">
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
            <polygon points="0 0, 10 3, 0 6" fill="#6c757d" />
        </marker>
    </defs>
    
    <!-- 상단 흐름 (5개 노드) -->
    
    <!-- 현재 고객 -->
    <rect x="30" y="30" width="150" height="70" class="node-box"/>
    <text x="105" y="55" class="node-text-title">현재 고객</text>
    <text x="105" y="85" class="node-text-value">${data.현재고객}명</text>
    
    <!-- 화살표: 현재 고객 → 월간 이탈 -->
    <line x1="180" y1="65" x2="245" y2="65" class="arrow"/>
    <text x="213" y="55" class="arrow-label">-</text>
    
    <!-- 월간 이탈 -->
    <rect x="245" y="30" width="150" height="70" class="node-box"/>
    <text x="320" y="55" class="node-text-title">월간 이탈</text>
    <text x="320" y="85" class="node-text-value">${data.월간이탈}명</text>
    
    <!-- 화살표: 월간 이탈 → 추천 -->
    <line x1="395" y1="65" x2="460" y2="65" class="arrow"/>
    <text x="428" y="55" class="arrow-label">+</text>
    
    <!-- 추천 -->
    <rect x="460" y="30" width="150" height="70" class="node-box"/>
    <text x="535" y="55" class="node-text-title">추천</text>
    <text x="535" y="85" class="node-text-value">${data.추천}명</text>
    
    <!-- 화살표: 추천 → 신규 고객 -->
    <line x1="610" y1="65" x2="675" y2="65" class="arrow"/>
    <text x="643" y="55" class="arrow-label">+</text>
    
    <!-- 신규 고객 -->
    <rect x="675" y="30" width="150" height="70" class="node-box"/>
    <text x="750" y="55" class="node-text-title">신규 고객</text>
    <text x="750" y="85" class="node-text-value">${data.신규고객}명</text>
    
    <!-- 화살표: 신규 고객 → 활성 고객 -->
    <line x1="825" y1="65" x2="890" y2="65" class="arrow"/>
    <text x="858" y="55" class="arrow-label">=</text>
    
    <!-- 활성 고객 -->
    <rect x="890" y="30" width="150" height="70" class="node-box"/>
    <text x="965" y="55" class="node-text-title">활성 고객</text>
    <text x="965" y="85" class="node-text-value">${data.활성고객}명</text>
    
    <!-- 하단 흐름 -->
    
    <!-- 월 방문자 -->
    <rect x="30" y="260" width="150" height="70" class="node-box"/>
    <text x="105" y="285" class="node-text-title">월 방문자</text>
    <text x="105" y="315" class="node-text-value">${data.월방문자}명</text>
    
    <!-- 화살표: 월 방문자 → 솔루션 -->
    <line x1="180" y1="295" x2="295" y2="295" class="arrow"/>
    <text x="238" y="285" class="arrow-label">활보</text>
    <text x="238" y="310" class="rate-label">${data.활보율}%</text>
    
    <!-- 솔루션 (육각형) -->
    <polygon points="350,265 420,265 450,295 420,325 350,325 320,295" class="node-factory"/>
    <text x="385" y="290" class="node-text-title">솔루션</text>
    <text x="385" y="310" class="node-text-title">(공장)</text>
    
    <!-- 화살표: 솔루션 → 관심 고객 -->
    <line x1="450" y1="295" x2="565" y2="295" class="arrow"/>
    
    <!-- 관심 고객 -->
    <rect x="565" y="260" width="150" height="70" class="node-box"/>
    <text x="640" y="285" class="node-text-title">관심 고객</text>
    <text x="640" y="315" class="node-text-value">${data.관심고객}명</text>
    
    <!-- 피드백 루프들 (곡선 화살표) -->
    
    <!-- 이탈 → 솔루션 곡선 화살표 -->
    <path d="M 320 100 Q 320 185 385 265" class="arrow-curved"/>
    <text x="280" y="170" class="rate-label">이탈 ${data.이탈율}%</text>
    
    <!-- 추천 → 솔루션 곡선 화살표 -->
    <path d="M 535 100 Q 460 185 385 265" class="arrow-curved"/>
    <text x="490" y="170" class="rate-label">추천 ${data.추천율}%</text>
    
    <!-- 신규 고객 → 관심 고객 곡선 화살표 -->
    <path d="M 750 100 Q 750 180 640 260" class="arrow-curved"/>
    <text x="770" y="170" class="rate-label">전환 ${data.전환율}%</text>
    
    <!-- 관심 고객 → 솔루션 곡선 화살표 (유지) -->
    <path d="M 565 295 Q 507 295 450 295" class="arrow-curved"/>
    <text x="507" y="350" class="rate-label">유지</text>
</svg>
            `;
            
            // 기존 SVG가 있으면 교체, 없으면 추가
            const existingSvg = container.querySelector('svg');
            if (existingSvg) {
                existingSvg.outerHTML = svg;
            } else {
                container.innerHTML = svg;
            }
        }

        // 페이지 로드 시 자동으로 데이터 불러오기
        window.addEventListener('load', loadFromSheets);
    </script>
</body>
</html>
